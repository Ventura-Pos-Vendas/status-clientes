<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Casos</title>
    <style>
/* Estilos do Login */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1E1E1E 0%, #1E1E1E 100%);/*fundo da pagina de login*/
    /*background: url('https://raw.githubusercontent.com/Ventura-Pos-Vendas/teste-status-clientes/main/assets/fundonatal2.png') center/cover no-repeat;/*fundo do login*/
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.login-container {
    background: linear-gradient(135deg, #272727 0%, #303030 100%);/*cor fundo container de login*/
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    max-width: 400px;
    width: 90%;
    text-align: center;
}

.login-container h2 {
    color: #f5f5f5;
    margin-bottom: 10px;
    font-size: 28px;
}

.login-container p {
    color: #ffffff;
    margin-bottom: 30px;
}

.login-input {
    width: 100%;
    padding: 15px;
    border: 2px solid #3498db;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    outline: none;
    transition: border-color 0.3s;
}

.login-input:focus {
    border-color: #2980b9;
}

.login-btn {
    background: #a50000;/*cor do bot√£o login*/
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s;
}

.login-btn:hover {
    background: #219a52;
}

.login-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
}

.error-message {
    color: #e74c3c;
    margin-top: 15px;
    display: none;
}

/* Estilos existentes do sistema */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    /*background: url('https://raw.githubusercontent.com/Ventura-Pos-Vendas/teste-status-clientes/main/assets/fundonatal2.png') center/cover no-repeat;*/
    background: linear-gradient(135deg, #1E1E1E 0%, #1E1E1E 100%);/*cor de fundo apos login*/
    color: #333;
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    overflow: hidden;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
    background-color: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
}

header {
    background: #000000;/*cor da tab principal*/
    color: white;
    padding: 25px;
    text-align: center;
    flex-shrink: 0;
}

h1 {
    font-size: 28px;
    margin-bottom: 0;
}

.tabs {
    display: flex;
    background: #34495e;
    flex-shrink: 0;
}

.tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    background:  #292929;/*tab nao selecionada entra vendas e garantias*/
    color: white;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: background 0.3s;
}

.tab:hover {
    background: #3c6d58;
}

.tab.active {
    background:#27ae60;/*cor da tab ativa*/
}

.search-container {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
}

.search-box {
    display: flex;
    max-width: 500px;
    margin: 0 auto;
}

.search-box input {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #3498db;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s;
}

.search-box input:focus {
    border-color: #2980b9;
}

.refresh-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    margin-left: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
}

.refresh-btn:hover {
    background: #219a52;
}

.cases-container {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.case-item {
    padding: 18px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
    cursor: pointer;
}

.case-item:hover {
    background: #f8f9fa;
}

.case-info {
    flex: 1;
}

.case-title {
    font-weight: 600;
    font-size: 18px;
    margin-bottom: 5px;
    color: #2c3e50;
}

.case-protocolo {
    font-size: 14px;
    color: #6c757d;
    margin-left: 10px;
    background: #f8f9fa;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: normal;
}

.case-details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    color: #6c757d;
    font-size: 14px;
}

.case-details span {
    white-space: nowrap;
}

.case-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

/* Status de cores */
.status-bo {
    background-color: #000000 !important;
    color: white !important;
}

.status-faturado {
    background-color: #28a745 !important;
    color: white !important;
}

.status-encomendado {
    background-color: #0400e7 !important;
    color: white !important;
}

.status-faturado-encomendado {
    background-color: #007bff !important;
    color: white !important;
}

.status-em-processamento {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.status-em-analise {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.status-aprovado {
    background-color: #28a745 !important;
    color: white !important;
}

.status-recusado {
    background-color: #dc3545 !important;
    color: white !important;
}

.status-enviado {
    background-color: #50289b !important;
    color: white !important;
}

.status-default {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

.loading {
    text-align: center;
    padding: 40px;
    font-size: 18px;
    color: #3498db;
}

.error {
    text-align: center;
    padding: 40px;
    background-color: #f8d7da;
    color: #721c24;
    border-radius: 8px;
    margin: 20px;
}

.empty {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    font-style: italic;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 15px;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
    color: #2c3e50;
}

.modal-protocolo {
    font-size: 16px;
    color: #6c757d;
    background: #f8f9fa;
    padding: 4px 10px;
    border-radius: 4px;
    margin-top: 5px;
    font-weight: normal;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
}

.modal-details {
    margin-bottom: 20px;
}

.modal-detail {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.modal-detail strong {
    width: 160px;
    color: #495057;
    flex-shrink: 0;
    margin-right: 15px;
}

.modal-detail span {
    flex: 1;
    word-break: break-word;
}

.modal-description {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #3498db;
    white-space: pre-line;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Estilos para os bot√µes de a√ß√£o do BO */
.bo-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
    width: 100%;
}

.bo-action-btn {
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
    width: 100%;
}

.action-outro-site {
    background: #28a745;
    color: white;
}

.action-outro-site:hover {
    background: #218838;
}

.action-faturar-disponiveis {
    background: #007bff;
    color: white;
}

.action-faturar-disponiveis:hover {
    background: #0056b3;
}

.action-cancelar {
    background: #dc3545;
    color: white;
}

.action-cancelar:hover {
    background: #c82333;
}

/* Novo bot√£o para solicitar compra */
.action-solicitar-compra {
    background: #ff9800;
    color: white;
}

.action-solicitar-compra:hover {
    background: #e68900;
}

footer {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    color: #6c757d;
    font-size: 14px;
    border-top: 1px solid #e9ecef;
    flex-shrink: 0;
}

.logout-btn {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 10px;
}

@media (max-width: 600px) {
    .case-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .case-status {
        margin-top: 10px;
        align-self: flex-end;
    }
    
    .case-details {
        flex-direction: column;
        gap: 8px;
    }
    
    .search-box {
        flex-direction: column;
    }
    
    .refresh-btn {
        margin-left: 0;
        margin-top: 10px;
    }
    
    .modal-content {
        padding: 20px;
        margin: 20px;
    }
    
    .modal-detail {
        flex-direction: column;
        gap: 5px;
    }
    
    .modal-detail strong {
        width: auto;
        margin-right: 0;
    }
    
    .modal-detail span {
        width: 100%;
    }
    
    .bo-actions {
        flex-direction: column;
    }
    
    .case-protocolo {
        margin-left: 0;
        margin-top: 5px;
        display: block;
    }

    /* Spinner para bot√£o Atualizar */
    .fa-spin {
        animation: fa-spin 1s infinite linear;
    }

    @keyframes fa-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Tela de Login -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div style="margin-bottom: 20px;">
                <img src="https://raw.githubusercontent.com/Ventura-Pos-Vendas/teste-status-clientes/main/assets/LogoAnoNovoo.png" 
                    alt="Logo da Empresa" 
                    style="max-width: 200px; height: auto; border-radius: 8px;">
            </div>
            <h2>Area do Dealer</h2>
            <p>Digite seu login para visualizar seus casos</p>
            
            <input type="text" id="loginInput" class="login-input" placeholder="Digite seu login" autocomplete="off">
            
            <button id="loginBtn" class="login-btn">
                Acessar Meus Casos
            </button>
            
            <div id="loginError" class="error-message">
                Login n√£o encontrado. Verifique se digitou corretamente.
            </div>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente escondido) -->
    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <h1 id="headerTitle">Meus Casos</h1>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="vendas">Vendas</button>
            <button class="tab" data-tab="garantias">Garantias</button>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por caso, protocolo, nome ou status...">
                <button class="refresh-btn" id="refreshBtn">Atualizar</button>
            </div>
        </div>
        
        <div class="cases-container" id="casesContainer">
            <div class="loading" id="loadingMessage">
                Carregando dados...
            </div>
        </div>
        
        <footer id="mainFooter">
            Sistema de Gest√£o
        </footer>
    </div>

    <!-- Modal para mostrar detalhes -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="modalTitle">Detalhes do Caso</h3>
                    <div class="modal-protocolo" id="modalProtocolo"></div>
                </div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-details">
                <div class="modal-detail">
                    <strong>Data:</strong>
                    <span id="modalDate"></span>
                </div>
                <div class="modal-detail">
                    <strong>Nome:</strong>
                    <span id="modalName"></span>
                </div>
                <div class="modal-detail" id="chassiDetail" style="display: none;">
                    <strong>Chassi:</strong>
                    <span id="modalChassi"></span>
                </div>
                <div class="modal-detail" id="modeloDetail" style="display: none;">
                    <strong>Modelo:</strong>
                    <span id="modalModelo"></span>
                </div>
                <div class="modal-detail">
                    <strong>Status:</strong>
                    <span id="modalStatus"></span>
                </div>
            </div>
            <div>
                <strong>Descri√ß√£o:</strong>
                <div class="modal-description" id="modalDescription">
                    Carregando descri√ß√£o...
                </div>
            </div>
            <!-- Bot√µes espec√≠ficos para status BO -->
            <div class="bo-actions" id="boActions" style="display: none;">
                <button class="bo-action-btn action-outro-site" onclick="openOtherSite()">
                    <i class="fas fa-external-link-alt"></i>
                    FATURAR DISPON√çVEIS E ENCOMENDAR RESTANTE
                </button>
                <button class="bo-action-btn action-faturar-disponiveis" onclick="handleBoAction('faturar-disponiveis')">
                    <i class="fas fa-check"></i>
                    FATURAR SOMENTE DISPON√çVEIS
                </button>
                <button class="bo-action-btn action-cancelar" onclick="handleBoAction('cancelar')">
                    <i class="fas fa-times-circle"></i>
                    CANCELAR PEDIDO
                </button>
            </div>
            <!-- Bot√£o para solicitar compra (aparece quando status √© RECUSADO) -->
            <div class="bo-actions" id="solicitarCompraActions" style="display: none; margin-top: 10px;">
                <button class="bo-action-btn action-solicitar-compra" onclick="openOtherSite()">
                    <i class="fas fa-shopping-cart"></i>
                    SOLICITAR COMPRA
                </button>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentTab = 'vendas';
        let allData = { vendas: [], garantias: [], logins: [] };
        let currentCaseData = null;
        let clienteLogado = null;
        let clienteKeys = [];

        // Elementos
        const loginOverlay = document.getElementById('loginOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const loginInput = document.getElementById('loginInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const headerTitle = document.getElementById('headerTitle');
        const mainFooter = document.getElementById('mainFooter');
        const searchInput = document.getElementById('searchInput');
        const casesContainer = document.getElementById('casesContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const refreshBtn = document.getElementById('refreshBtn');
        const tabs = document.querySelectorAll('.tab');
        const caseModal = document.getElementById('caseModal');
        const closeModal = document.getElementById('closeModal');
        const boActions = document.getElementById('boActions');
        const solicitarCompraActions = document.getElementById('solicitarCompraActions');
        
        // Elementos para chassi e modelo (garantias)
        const chassiDetail = document.getElementById('chassiDetail');
        const modeloDetail = document.getElementById('modeloDetail');
        const modalChassi = document.getElementById('modalChassi');
        const modalModelo = document.getElementById('modalModelo');
        const modalProtocolo = document.getElementById('modalProtocolo');

        // URL do Google Apps Script
        const API_URL = "https://script.google.com/macros/s/AKfycby415ILlF2HcH-RL1ZhhsbbW_fku3yK0bb3B9WFsbvKIb3MU0t9ltC25jU_sw6-G3sq/exec";
        
        // URL para o outro site (ALTERE AQUI COM SUA URL)
        const OTHER_SITE_URL = "https://ventura-pos-vendas.github.io/Ventura-Pos-Vendas/";

        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        
        // Enter no campo de login
        loginInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin();
            }
        });
        
        // Focar no campo de login ao carregar a p√°gina
        window.addEventListener('load', function() {
            loginInput.focus();
        });

        // Fun√ß√£o de login
        function handleLogin() {
            const login = loginInput.value.trim();
            
            if (!login) {
                showLoginError('Por favor, digite seu login');
                loginInput.focus();
                return;
            }
            
            // Desabilitar bot√£o durante o login
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            
            // Verificar se os dados j√° foram carregados
            if (allData.logins.length === 0) {
                loadAllData(login);
            } else {
                verifyLogin(login);
            }
        }

        // Fun√ß√£o para verificar login APENAS na planilha de logins
        function verifyLogin(login) {
            console.log('Verificando login:', login);
            
            // Buscar APENAS na planilha de logins
            const loginData = allData.logins.find(item => 
                item.login && item.login.toLowerCase() === login.toLowerCase()
            );
            
            if (loginData && loginData.keys && loginData.keys.length > 0) {
                clienteKeys = loginData.keys;
                console.log('Login encontrado! Keys:', clienteKeys);
                loginSuccess(login);
            } else {
                showLoginError('Login n√£o encontrado na base de dados.');
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Acessar Meus Casos';
                loginInput.focus();
            }
        }

        // Login bem-sucedido
        function loginSuccess(login) {
            clienteLogado = login;
            loginOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
            
            // Deixar apenas "Meus Casos" no t√≠tulo
            headerTitle.innerHTML = `Meus Casos`;
            
            // Atualizar rodap√©
            mainFooter.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Logado como: <strong>${login}</strong></span>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            `;
            
            // Event listener para logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Deseja realmente sair do sistema?')) {
                    clienteLogado = null;
                    clienteKeys = [];
                    mainContainer.style.display = 'none';
                    loginOverlay.style.display = 'flex';
                    loginInput.value = '';
                    loginError.style.display = 'none';
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'Acessar Meus Casos';
                    loginInput.focus();
                    
                    // Limpar container de casos
                    casesContainer.innerHTML = '<div class="loading">Carregando dados...</div>';
                }
            });
            
            // MOSTRAR CASOS IMEDIATAMENTE AP√ìS LOGIN
            displayCases(allData[currentTab]);
            
            // Focar no campo de busca ap√≥s login
            setTimeout(() => {
                searchInput.focus();
            }, 300);
        }

        // Mostrar erro de login
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
            
            // Esconder erro ap√≥s 5 segundos
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 5000);
        }

        // Fun√ß√£o para carregar todos os dados usando JSONP
        function loadAllData(login = null) {
            loadingMessage.textContent = 'Carregando dados...';
            loadingMessage.style.display = 'block';
            
            const timestamp = new Date().getTime();
            const callbackName = 'jsonpCallback_' + timestamp;
            
            window[callbackName] = function(data) {
                console.log('Dados recebidos:', data);
                
                allData.vendas = data.vendas || [];
                allData.garantias = data.garantias || [];
                allData.logins = data.logins || [];
                
                console.log('Logins carregados:', allData.logins.length);
                console.log('Vendas carregadas:', allData.vendas.length);
                console.log('Garantias carregadas:', allData.garantias.length);
                
                if (login) {
                    // Se veio do login, verifica login
                    verifyLogin(login);
                } else {
                    // Se veio do bot√£o Atualizar, atualiza a exibi√ß√£o
                    displayCases(allData[currentTab]);
                    loadingMessage.style.display = 'none';
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'Acessar Meus Casos';
                    // REATIVAR bot√£o Atualizar
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'Atualizar';
                }
                
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=${callbackName}&t=${timestamp}`;
            script.onerror = function() {
                loadingMessage.innerHTML = '<div class="error">Erro ao carregar dados. Tente novamente.</div>';
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Acessar Meus Casos';
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // Event Listeners para as abas
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.dataset.tab;
                displayCases(allData[currentTab]);
                
                // Focar no campo de busca ap√≥s trocar aba
                searchInput.focus();
            });
        });

        // Event Listener para atualizar
        refreshBtn.addEventListener('click', function() {
            // Desabilitar bot√£o e mostrar spinner
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
            
            loadingMessage.textContent = 'Atualizando dados...';
            loadingMessage.style.display = 'block';
            
            loadAllData();
        });

        // Event Listeners para o modal
        closeModal.addEventListener('click', function() {
            caseModal.style.display = 'none';
        });

        caseModal.addEventListener('click', function(e) {
            if (e.target === caseModal) {
                caseModal.style.display = 'none';
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && caseModal.style.display === 'flex') {
                caseModal.style.display = 'none';
            }
        });

        // Fun√ß√£o para abrir outro site
        function openOtherSite() {
            window.open(OTHER_SITE_URL, '_blank');
        }

        // Fun√ß√£o para lidar com outras a√ß√µes do BO
        function handleBoAction(action) {
            if (!currentCaseData) return;
            
            let message = '';
            
            switch(action) {
                case 'faturar-disponiveis':
                    message = `Ol√°! Referente ao caso *${currentCaseData.caso}* que est√° com status BO.\n\n` +
                             `*Solicito:* FATURAR SOMENTE DISPON√çVEIS\n` +
                             `Os itens indispon√≠veis devem ser cancelados.\n\n` +
                             `*Detalhes do caso:*\n` +
                             `Data: ${formatDate(currentCaseData.data)}\n` +
                             `Nome: ${currentCaseData.nome || 'N√£o informado'}\n` +
                             `Descri√ß√£o: ${currentCaseData.descricao || 'Sem descri√ß√£o'}`;
                    break;
                    
                case 'cancelar':
                    message = `Ol√°! Referente ao caso *${currentCaseData.caso}* que est√° com status BO.\n\n` +
                             `*Solicito:* CANCELAR PEDIDO\n\n` +
                             `*Detalhes do caso:*\n` +
                             `Data: ${formatDate(currentCaseData.data)}\n` +
                             `Nome: ${currentCaseData.nome || 'N√£o informado'}\n` +
                             `Descri√ß√£o: ${currentCaseData.descricao || 'Sem descri√ß√£o'}`;
                    break;
            }
            
            const phoneNumber = "5516996174440";
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // Fun√ß√£o para obter casos do cliente baseado nas keys
        function getClientCases(cases) {
            if (!clienteKeys || clienteKeys.length === 0) return [];
            
            return cases.filter(item => {
                const itemKey = item.key ? String(item.key).trim() : '';
                if (!itemKey) return false;
                
                return clienteKeys.some(clientKey => 
                    clientKey.toLowerCase() === itemKey.toLowerCase()
                );
            });
        }

        // Fun√ß√£o para exibir os casos
        function displayCases(cases) {
            loadingMessage.style.display = 'block';
            
            setTimeout(() => {
                if (!cases || cases.length === 0) {
                    casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado</div>';
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                // Filtrar casos baseado nas keys do cliente
                let filteredCases = getClientCases(cases);
                
                if (filteredCases.length === 0) {
                    casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado para voc√™</div>';
                } else {
                    renderCases(filteredCases);
                }
                
                loadingMessage.style.display = 'none';
            }, 100);
        }

        // Fun√ß√£o para renderizar os casos na tela
        function renderCases(cases) {
            let html = '';
            
            // Ordenar casos por data (mais recente primeiro)
            const sortedCases = cases.sort((a, b) => {
                const dateA = new Date(a.data) || new Date(0);
                const dateB = new Date(b.data) || new Date(0);
                return dateB - dateA;
            });
            
            sortedCases.forEach((item, index) => {
                const statusClass = getStatusClass(item.status);
                
                html += `
                    <div class="case-item" data-index="${index}" title="Clique para ver detalhes">
                        <div class="case-info">
                            <div class="case-title">
                                Caso: ${item.caso || 'Sem t√≠tulo'}
                                ${item.protocolo ? `<span class="case-protocolo">Protocolo: ${item.protocolo}</span>` : ''}
                            </div>
                            <div class="case-details">
                                <span><i class="far fa-calendar"></i> ${formatDate(item.data)}</span>
                                <span><i class="far fa-user"></i> ${item.nome || 'N√£o informado'}</span>
                                ${currentTab === 'garantias' && item.chassi ? 
                                    `<span><i class="fas fa-car"></i> ${item.chassi || 'N√£o informado'}</span>` : ''
                                }
                            </div>
                        </div>
                        <div class="case-status ${statusClass}">
                            <i class="fas fa-circle"></i> ${item.status || 'Pendente'}
                        </div>
                    </div>
                `;
            });
            
            casesContainer.innerHTML = html;
            
            // Adicionar event listeners aos casos
            document.querySelectorAll('.case-item').forEach((item, index) => {
                item.addEventListener('click', function() {
                    showCaseDetails(sortedCases[index]);
                });
                
                // Tornar os casos foc√°veis para acessibilidade
                item.setAttribute('tabindex', '0');
            });
        }

        // Fun√ß√£o para mostrar detalhes do caso
        function showCaseDetails(caseData) {
            currentCaseData = caseData;
            
            // Definir t√≠tulo com Caso e Protocolo
            let modalTitleText = `Caso: ${caseData.caso || 'Sem t√≠tulo'}`;

            document.getElementById('modalTitle').textContent = modalTitleText;
            
            // Mostrar protocolo separadamente tamb√©m
            if (caseData.protocolo) {
                modalProtocolo.innerHTML = `Protocolo: ${caseData.protocolo} 
                    <button class="copy-btn" title="Copiar">
                        üìÑ<br>Copiar
                    </button>`;
                modalProtocolo.style.display = 'block';
                
                // Adicionar fun√ß√£o de copiar
                const copyBtn = modalProtocolo.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.onclick = function() {
                        navigator.clipboard.writeText(caseData.protocolo)
                            .then(() => {
                                this.textContent = '‚úì';
                                setTimeout(() => this.innerHTML = 'üìÑ<br>Copiar', 2000);
                            })
                            .catch(() => {
                                // Fallback simples
                                const input = document.createElement('input');
                                input.value = caseData.protocolo;
                                document.body.appendChild(input);
                                input.select();
                                document.execCommand('copy');
                                document.body.removeChild(input);
                                
                                this.textContent = '‚úì';
                                setTimeout(() => this.textContent = 'üìã', 2000);
                            });
                    };
                }
            } else {
                modalProtocolo.style.display = 'none';
            }
            
            document.getElementById('modalDate').textContent = formatDate(caseData.data);
            document.getElementById('modalName').textContent = caseData.nome || 'N√£o informado';
            document.getElementById('modalStatus').textContent = caseData.status || 'Pendente';
            document.getElementById('modalStatus').className = 'case-status ' + getStatusClass(caseData.status);
            document.getElementById('modalDescription').textContent = caseData.descricao || 'Sem descri√ß√£o';
            
            // Mostrar ou esconder chassi e modelo para garantias
            if (currentTab === 'garantias') {
                chassiDetail.style.display = 'flex';
                modeloDetail.style.display = 'flex';
                modalChassi.textContent = caseData.chassi || 'N√£o informado';
                modalModelo.textContent = caseData.modelo || 'N√£o informado';
            } else {
                chassiDetail.style.display = 'none';
                modeloDetail.style.display = 'none';
            }
            
            // Mostrar bot√µes espec√≠ficos para BO
            const statusUpper = caseData.status ? caseData.status.toUpperCase() : '';
            if (statusUpper === 'BO') {
                boActions.style.display = 'flex';
                solicitarCompraActions.style.display = 'none';
            } else if (statusUpper.includes('RECUSADO')) {
                boActions.style.display = 'none';
                solicitarCompraActions.style.display = 'flex';
            } else {
                boActions.style.display = 'none';
                solicitarCompraActions.style.display = 'none';
            }
            
            caseModal.style.display = 'flex';
            
            // Focar no bot√£o de fechar modal para acessibilidade
            setTimeout(() => {
                closeModal.focus();
            }, 100);
        }

        // Fun√ß√£o de filtro
        function filterCases() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayCases(allData[currentTab]);
                return;
            }
            
            const allClientCases = getClientCases(allData[currentTab]);
            
            if (allClientCases.length === 0) {
                casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado para voc√™</div>';
                return;
            }
            
            const filteredCases = allClientCases.filter(item => {
                const searchableFields = [
                    item.caso || '',
                    item.protocolo || '',
                    item.nome || '',
                    item.status || '',
                    item.data ? formatDate(item.data) : '',
                    item.descricao || '',
                    ...(currentTab === 'garantias' ? [
                        item.chassi || '',
                        item.modelo || ''
                    ] : [])
                ];
                
                return searchableFields.some(field => 
                    field.toString().toLowerCase().includes(searchTerm)
                );
            });
            
            if (filteredCases.length === 0) {
                casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado com esses crit√©rios de busca</div>';
            } else {
                renderCases(filteredCases);
            }
        }

        // Fun√ß√£o para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N√£o informada';
            
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) return dateString;
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }
            
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.log('Erro ao formatar data:', e);
            }
            
            return dateString;
        }

        // Fun√ß√£o para obter a classe CSS baseada no status
        function getStatusClass(status) {
            if (!status) return 'status-default';
            const statusUpper = status.toUpperCase();
            
            const statusMap = {
                'BO': 'status-bo',
                'FATURADO': 'status-faturado',
                'ENCOMENDADO': 'status-encomendado',
                'FATURADO/ENCOMENDADO': 'status-faturado-encomendado',
                'FATURADO ENCOMENDADO': 'status-faturado-encomendado',
                'EM PROCESSAMENTO': 'status-em-processamento',
                'EM PROCESSO': 'status-em-processamento',
                'PROCESSANDO': 'status-em-processamento',
                'EM AN√ÅLISE': 'status-em-analise',
                'ANALISE': 'status-em-analise',
                'AN√ÅLISE': 'status-em-analise',
                'APROVADO': 'status-aprovado',
                'RECUSADO': 'status-recusado',
                'ENVIADO': 'status-enviado',
                'AGUARDANDO': 'status-aguardando-envio'
            };
            
            if (statusMap[statusUpper]) {
                return statusMap[statusUpper];
            }
            
            for (const [key, value] of Object.entries(statusMap)) {
                if (statusUpper.includes(key)) {
                    return value;
                }
            }
            
            return 'status-default';
        }

        // Event Listener para filtro em tempo real
        searchInput.addEventListener('input', filterCases);

        // Carregar dados ao iniciar
        loadAllData();
        
        // Focar no campo de login
        window.addEventListener('load', function() {
            setTimeout(() => loginInput.focus(), 500);
        });
    </script>
    
</body>
</html>