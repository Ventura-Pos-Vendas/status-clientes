<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Casos - Login</title>
    <style>
        /* Estilos do Login */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-container p {
            color: #6c757d;
            margin-bottom: 30px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .login-input:focus {
            border-color: #2980b9;
        }
        
        .login-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #219a52;
        }
        
        .login-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            display: none;
        }

        /* Estilos existentes do sistema */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #34495e;
            flex-shrink: 0;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .tab:hover {
            background: #3c556d;
        }
        
        .tab.active {
            background: #3498db;
        }
        
        .search-container {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        .search-box {
            display: flex;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            border-color: #2980b9;
        }
        
        .refresh-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #219a52;
        }
        
        .cases-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .case-item {
            padding: 18px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .case-item:hover {
            background: #f8f9fa;
        }
        
        .case-info {
            flex: 1;
        }
        
        .case-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .case-details {
            display: flex;
            gap: 15px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .case-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-andamento {
            background-color: #cce7ff;
            color: #004085;
        }
        
        .status-concluido {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-cancelado {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-bo {
            background-color: #ff6b6b;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #3498db;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            margin: 20px;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .modal-details {
            margin-bottom: 20px;
        }
        
        .modal-detail {
            margin-bottom: 10px;
            display: flex;
        }
        
        .modal-detail strong {
            width: 100px;
            color: #495057;
        }
        
        .modal-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            white-space: pre-line;
            line-height: 1.5;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s;
            width: 100%;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
        }
        
        .whatsapp-btn i {
            font-size: 18px;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 14px;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        @media (max-width: 600px) {
            .case-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .case-status {
                margin-top: 10px;
                align-self: flex-end;
            }
            
            .case-details {
                flex-direction: column;
                gap: 5px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .refresh-btn {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Tela de Login -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2>Acesso do Cliente</h2>
            <p>Digite seu login para visualizar seus casos</p>
            
            <input type="text" id="loginInput" class="login-input" placeholder="Digite seu login" autocomplete="off">
            
            <button id="loginBtn" class="login-btn">
                Acessar Meus Casos
            </button>
            
            <div id="loginError" class="error-message">
                Login não encontrado. Verifique se digitou corretamente.
            </div>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente escondido) -->
    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <h1 id="headerTitle">Sistema de Vendas e Garantias</h1>
            <p id="headerSubtitle">Gerencie seus casos de forma eficiente</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="vendas">Vendas</button>
            <button class="tab" data-tab="garantias">Garantias</button>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por caso, nome ou status...">
                <button class="refresh-btn" id="refreshBtn">Atualizar</button>
            </div>
        </div>
        
        <div class="cases-container" id="casesContainer">
            <div class="loading" id="loadingMessage">
                Carregando dados...
            </div>
        </div>
        
        <footer id="mainFooter">
            Sistema de Gestão - Carregamento Instantâneo
        </footer>
    </div>

    <!-- Modal para mostrar detalhes -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detalhes do Caso</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-details">
                <div class="modal-detail">
                    <strong>Data:</strong>
                    <span id="modalDate"></span>
                </div>
                <div class="modal-detail">
                    <strong>Responsável:</strong>
                    <span id="modalName"></span>
                </div>
                <div class="modal-detail">
                    <strong>Status:</strong>
                    <span id="modalStatus"></span>
                </div>
            </div>
            <div>
                <strong>Descrição:</strong>
                <div class="modal-description" id="modalDescription">
                    Carregando descrição...
                </div>
            </div>
            <button class="whatsapp-btn" id="whatsappBtn" style="display: none;">
                <i class="fab fa-whatsapp"></i>
                Abrir no WhatsApp
            </button>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentTab = 'vendas';
        let allData = { vendas: [], garantias: [] };
        let currentCaseData = null;
        let clienteLogado = null;

        // Elementos
        const loginOverlay = document.getElementById('loginOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const loginInput = document.getElementById('loginInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const headerTitle = document.getElementById('headerTitle');
        const headerSubtitle = document.getElementById('headerSubtitle');
        const mainFooter = document.getElementById('mainFooter');
        const searchInput = document.getElementById('searchInput');
        const casesContainer = document.getElementById('casesContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const refreshBtn = document.getElementById('refreshBtn');
        const tabs = document.querySelectorAll('.tab');
        const caseModal = document.getElementById('caseModal');
        const closeModal = document.getElementById('closeModal');
        const whatsappBtn = document.getElementById('whatsappBtn');

        // URL do Google Apps Script
        const API_URL = "https://script.google.com/macros/s/AKfycbzk9mAUQgUd65R_lmMNLvFgRPY42UUaBJVmqHw7fQO_mQ1BCcF7nPABMsZjG5pHQMij/exec";

        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        loginInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });

        // Função de login
        function handleLogin() {
            const login = loginInput.value.trim();
            
            if (!login) {
                showLoginError('Por favor, digite seu login');
                return;
            }
            
            // Verificar se os dados já foram carregados
            if (allData.vendas.length === 0 && allData.garantias.length === 0) {
                loadAllData(login);
            } else {
                verifyLogin(login);
            }
        }

        // Função para verificar login
        function verifyLogin(login) {
            const allCases = [...allData.vendas, ...allData.garantias];
            
            // Debug: verificar o que tem nos dados
            console.log('Todos os casos:', allCases);
            console.log('Login procurado:', login);
            
            const clienteValido = allCases.some(caso => {
                // Verificar se caso.login existe e é uma string
                if (!caso.login || typeof caso.login !== 'string') {
                    console.log('Caso sem login válido:', caso);
                    return false;
                }
                return caso.login.toLowerCase() === login.toLowerCase();
            });
            
            console.log('Cliente válido:', clienteValido);
            
            if (clienteValido) {
                loginSuccess(login);
            } else {
                showLoginError('Login não encontrado. Verifique se digitou corretamente.');
            }
        }

        // Login bem-sucedido
        function loginSuccess(login) {
            clienteLogado = login;
            loginOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
            
            // Atualizar interface com nome do cliente
            headerTitle.innerHTML = `Meus Casos`;
            headerSubtitle.textContent = `Cliente: ${login}`;
            mainFooter.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Sistema de Gestão - Cliente: ${login}</span>
                    <button class="logout-btn" id="logoutBtn">Sair</button>
                </div>
            `;
            
            // Event listener para logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                clienteLogado = null;
                mainContainer.style.display = 'none';
                loginOverlay.style.display = 'flex';
                loginInput.value = '';
                loginError.style.display = 'none';
            });
            
            // Mostrar casos do cliente
            displayCases(allData[currentTab]);
        }

        // Mostrar erro de login
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        // Função para carregar todos os dados usando JSONP
        function loadAllData(login = null) {
            loadingMessage.textContent = 'Carregando dados...';
            loadingMessage.style.display = 'block';
            
            const timestamp = new Date().getTime();
            const callbackName = 'jsonpCallback_' + timestamp;
            
            window[callbackName] = function(data) {
                console.log('Dados recebidos:', data); // Debug
                
                allData.vendas = data.vendas || [];
                allData.garantias = data.garantias || [];
                
                // Debug: verificar estrutura dos dados
                console.log('Estrutura do primeiro caso de vendas:', allData.vendas[0]);
                console.log('Estrutura do primeiro caso de garantias:', allData.garantias[0]);
                
                if (login) {
                    verifyLogin(login);
                } else {
                    loadingMessage.style.display = 'none';
                }
                
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=${callbackName}&t=${timestamp}`;
            script.onerror = function() {
                loadingMessage.innerHTML = '<div class="error">Erro ao carregar dados. Tente novamente.</div>';
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // [AS DEMAIS FUNÇÕES PERMANECEM EXATAMENTE IGUAIS...]
        // Event Listeners para as abas
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.dataset.tab;
                displayCases(allData[currentTab]);
            });
        });

        // Event Listener para atualizar
        refreshBtn.addEventListener('click', function() {
            loadingMessage.textContent = 'Atualizando dados...';
            loadingMessage.style.display = 'block';
            loadAllData();
        });

        // Event Listeners para o modal
        closeModal.addEventListener('click', function() {
            caseModal.style.display = 'none';
        });

        caseModal.addEventListener('click', function(e) {
            if (e.target === caseModal) {
                caseModal.style.display = 'none';
            }
        });

        // Event Listener para o botão do WhatsApp
        whatsappBtn.addEventListener('click', function() {
            if (currentCaseData) {
                openWhatsApp(currentCaseData);
            }
        });

        // Função para abrir WhatsApp
        function openWhatsApp(caseData) {
            const phoneNumber = "5516996174440";
            const message = `Olá! Gostaria de mais informações sobre o caso:\n\n` +
                           `*Caso:* ${caseData.caso || 'Sem título'}\n` +
                           `*Data:* ${formatDate(caseData.data)}\n` +
                           `*Status:* ${caseData.status || 'Pendente'}\n` +
                           `*Descrição:* ${caseData.descricao || 'Sem descrição'}\n\n` +
                           `Poderia me ajudar com esse BO?`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // Função para exibir os casos (FILTRADA POR LOGIN)
        function displayCases(cases) {
            if (!cases || cases.length === 0) {
                casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado</div>';
                return;
            }
            
            // Filtrar casos apenas do cliente logado
            let filteredCases = cases.filter(item => 
                item.login && item.login.toLowerCase() === clienteLogado.toLowerCase()
            );
            
            if (filteredCases.length === 0) {
                casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado para você</div>';
                return;
            }
            
            let html = '';
            filteredCases.forEach((item, index) => {
                const statusClass = getStatusClass(item.status);
                
                html += `
                    <div class="case-item" data-index="${index}">
                        <div class="case-info">
                            <div class="case-title">Caso: ${item.caso || 'Sem título'}</div>
                            <div class="case-details">
                                <span><strong>Data:</strong> ${formatDate(item.data)}</span>
                                <span><strong>Responsável:</strong> ${item.nome || 'Não informado'}</span>
                            </div>
                        </div>
                        <div class="case-status ${statusClass}">${item.status || 'Pendente'}</div>
                    </div>
                `;
            });
            
            casesContainer.innerHTML = html;
            
            document.querySelectorAll('.case-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = this.dataset.index;
                    showCaseDetails(filteredCases[index]);
                });
            });
        }

        // Função para mostrar detalhes do caso
        function showCaseDetails(caseData) {
            currentCaseData = caseData;
            document.getElementById('modalTitle').textContent = `CASO: ${caseData.caso || 'Sem título'}`;
            document.getElementById('modalDate').textContent = formatDate(caseData.data);
            document.getElementById('modalName').textContent = caseData.nome || 'Não informado';
            document.getElementById('modalStatus').textContent = caseData.status || 'Pendente';
            document.getElementById('modalStatus').className = 'case-status ' + getStatusClass(caseData.status);
            document.getElementById('modalDescription').textContent = caseData.descricao || 'Sem descrição';
            
            if (caseData.status && caseData.status.toUpperCase() === 'BO') {
                whatsappBtn.style.display = 'block';
            } else {
                whatsappBtn.style.display = 'none';
            }
            
            caseModal.style.display = 'flex';
        }

  // Função para filtrar casos em tempo real
function filterCases() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    // Primeiro, obter todos os casos do cliente logado da aba atual
    const allClientCases = allData[currentTab].filter(item => 
        item.login && item.login.toLowerCase() === clienteLogado.toLowerCase()
    );
    
    // Se não há termo de busca, mostrar todos os casos do cliente
    if (!searchTerm) {
        if (allClientCases.length === 0) {
            casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado para você</div>';
        } else {
            // Mostrar todos os casos do cliente
            let html = '';
            allClientCases.forEach((item, index) => {
                const statusClass = getStatusClass(item.status);
                html += `
                    <div class="case-item" data-index="${index}">
                        <div class="case-info">
                            <div class="case-title">Caso: ${item.caso || 'Sem título'}</div>
                            <div class="case-details">
                                <span><strong>Data:</strong> ${formatDate(item.data)}</span>
                                <span><strong>Responsável:</strong> ${item.nome || 'Não informado'}</span>
                            </div>
                        </div>
                        <div class="case-status ${statusClass}">${item.status || 'Pendente'}</div>
                    </div>
                `;
            });
            casesContainer.innerHTML = html;
            
            document.querySelectorAll('.case-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = this.dataset.index;
                    showCaseDetails(allClientCases[index]);
                });
            });
        }
        return;
    }
    
    // Filtrar casos baseado no termo de busca
    const filteredCases = allClientCases.filter(item => {
        return (
            (item.caso && item.caso.toLowerCase().includes(searchTerm)) ||
            (item.nome && item.nome.toLowerCase().includes(searchTerm)) ||
            (item.status && item.status.toLowerCase().includes(searchTerm)) ||
            (item.data && item.data.toString().toLowerCase().includes(searchTerm)) ||
            (item.descricao && item.descricao.toLowerCase().includes(searchTerm))
        );
    });
    
    // Mostrar resultados
    if (filteredCases.length === 0) {
        casesContainer.innerHTML = '<div class="empty">Nenhum caso encontrado com esses critérios</div>';
    } else {
        let html = '';
        filteredCases.forEach((item, index) => {
            const statusClass = getStatusClass(item.status);
            html += `
                <div class="case-item" data-index="${index}">
                    <div class="case-info">
                        <div class="case-title">Caso: ${item.caso || 'Sem título'}</div>
                        <div class="case-details">
                            <span><strong>Data:</strong> ${formatDate(item.data)}</span>
                            <span><strong>Responsável:</strong> ${item.nome || 'Não informado'}</span>
                        </div>
                    </div>
                    <div class="case-status ${statusClass}">${item.status || 'Pendente'}</div>
                </div>
            `;
        });
        casesContainer.innerHTML = html;
        
        document.querySelectorAll('.case-item').forEach(item => {
            item.addEventListener('click', function() {
                const index = this.dataset.index;
                showCaseDetails(filteredCases[index]);
            });
        });
    }
}
        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'Não informada';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) return date.toLocaleDateString('pt-BR');
            return dateString;
        }

        // Função para obter a classe CSS baseada no status
        function getStatusClass(status) {
            if (!status) return 'status-pendente';
            const statusLower = status.toLowerCase();
            switch(statusLower) {
                case 'pendente': return 'status-pendente';
                case 'em andamento': case 'andamento': return 'status-andamento';
                case 'concluído': case 'concluido': return 'status-concluido';
                case 'cancelado': return 'status-cancelado';
                case 'bo': return 'status-bo';
                default: return 'status-pendente';
            }
        }

        // Event Listener para filtro em tempo real
        searchInput.addEventListener('input', filterCases);

        // Carregar dados ao iniciar (sem login ainda)
        loadAllData();
    </script>
</body>
</html>